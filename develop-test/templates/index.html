<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŒ NASA Weather Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            margin-top: 20px;
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress {
            height: 25px;
            border-radius: 15px;
            background-color: #e9ecef;
        }
        .progress-bar {
            border-radius: 15px;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        .result-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        .status-success { background-color: #d4edda; color: #155724; }
        .status-warning { background-color: #fff3cd; color: #856404; }
        .status-error { background-color: #f8d7da; color: #721c24; }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .is-invalid {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }
        .alert {
            border-radius: 10px;
            margin-top: 15px;
        }
        .performance-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
            border: 2px solid #e9ecef;
        }
        .map-controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .coordinate-display {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸŒ NASA Weather Analysis</h1>
            <p class="lead">KapsamlÄ± Hava Durumu Analizi ve GÃ¶rselleÅŸtirme</p>
        </div>

        <!-- Map Section -->
        <div class="map-controls">
            <h4>ğŸ—ºï¸ Konum SeÃ§imi</h4>
            <p class="text-muted">Haritada alan seÃ§mek iÃ§in dikdÃ¶rtgen Ã§izin veya manuel koordinat girin.</p>
            <div class="row mb-3">
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-primary btn-sm" id="drawRectangle">
                        ğŸ“ Alan Ã‡iz
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-sm" id="clearMap">
                        ğŸ—‘ï¸ Temizle
                    </button>
                </div>
                <div class="col-md-6">
                    <button type="button" class="btn btn-outline-info btn-sm" id="useCurrentLocation">
                        ğŸ“ Mevcut Konum
                    </button>
                </div>
            </div>
            <div id="map"></div>
            <div id="coordinateDisplay" class="coordinate-display" style="display: none;">
                <small><strong>SeÃ§ilen Alan:</strong> <span id="selectedCoords">-</span></small>
            </div>
        </div>

        <form id="analysisForm">
            <div class="row">
                <div class="col-md-6">
                    <h4>ğŸ“ Koordinatlar</h4>
                    <div class="mb-3">
                        <label class="form-label">Min Enlem (Â°)</label>
                        <input type="number" class="form-control" id="lat_min" step="0.01" value="39.0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Enlem (Â°)</label>
                        <input type="number" class="form-control" id="lat_max" step="0.01" value="42.0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Min Boylam (Â°)</label>
                        <input type="number" class="form-control" id="lon_min" step="0.01" value="26.0" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Boylam (Â°)</label>
                        <input type="number" class="form-control" id="lon_max" step="0.01" value="45.0" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <h4>ğŸ“… Tarih AralÄ±ÄŸÄ±</h4>
                    <div class="mb-3">
                        <label class="form-label">BaÅŸlangÄ±Ã§ Tarihi</label>
                        <input type="date" class="form-control" id="start_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">BitiÅŸ Tarihi</label>
                        <input type="date" class="form-control" id="end_date" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Grid AdÄ±mÄ± (Â°)</label>
                        <input type="number" class="form-control" id="step" step="0.1" value="1.0" min="0.1" max="5.0">
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    ğŸš€ Analizi BaÅŸlat
                </button>
            </div>
        </form>

        <!-- Progress Section -->
        <div id="progressSection" style="display: none;">
            <hr>
            <h4>ğŸ“Š Ä°ÅŸlem Durumu</h4>
            <div class="progress mb-3">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <div id="progressStatus" class="text-center">
                <span class="status-badge status-warning">BaÅŸlÄ±yor...</span>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <hr>
            <h4>ğŸ“ˆ Analiz SonuÃ§larÄ±</h4>
            
            <!-- Risk Analysis Card -->
            <div class="result-card card mb-4" id="riskCard">
                <div class="card-header">
                    <h5>âš ï¸ Weather Risk Analysis</h5>
                </div>
                <div class="card-body">
                    <div id="riskAnalysis">
                        <!-- Risk analizi buraya gelecek -->
                    </div>
                </div>
            </div>

            <div id="statsGrid" class="stats-grid">
                <!-- Ä°statistikler buraya gelecek -->
            </div>

            <div class="result-card card mt-4">
                <div class="card-header">
                    <h5>ğŸ“Š Grafikler</h5>
                </div>
                <div class="card-body">
                    <div id="chartsContainer">
                        <!-- Grafikler buraya gelecek -->
                    </div>
                </div>
            </div>

            <!-- Export Section -->
            <div class="result-card card mt-4" id="exportCard">
                <div class="card-header">
                    <h5>ğŸ’¾ Veri Ä°ndirme</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Analiz sonuÃ§larÄ±nÄ± farklÄ± formatlarda indirebilirsiniz:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-primary w-100" id="exportJson">
                                ğŸ“„ JSON Ä°ndir
                            </button>
                            <small class="text-muted">TÃ¼m veri ve analiz sonuÃ§larÄ±</small>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-outline-success w-100" id="exportCsv">
                                ğŸ“Š CSV Ä°ndir
                            </button>
                            <small class="text-muted">Sadece ham veri (Excel iÃ§in uygun)</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentTaskId = null;
        let map = null;
        let drawnRectangle = null;
        let isDrawing = false;
        
        // BugÃ¼nÃ¼n tarihini set et ve haritayÄ± baÅŸlat
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 7);
            
            document.getElementById('end_date').value = today.toISOString().split('T')[0];
            document.getElementById('start_date').value = yesterday.toISOString().split('T')[0];
            
            initializeMap();
        });

        function initializeMap() {
            // HaritayÄ± baÅŸlat (TÃ¼rkiye merkez)
            map = L.map('map').setView([39.9334, 32.8597], 6);
            
            // OpenStreetMap tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);
            
            // Mevcut koordinatlarÄ± haritada gÃ¶ster
            updateMapRectangle();
            
            // Harita event listeners
            setupMapEvents();
        }

        function setupMapEvents() {
            // Rectangle drawing
            document.getElementById('drawRectangle').addEventListener('click', function() {
                if (isDrawing) {
                    stopDrawing();
                } else {
                    startDrawing();
                }
            });
            
            // Clear map
            document.getElementById('clearMap').addEventListener('click', function() {
                clearMapSelection();
            });
            
            // Use current location
            document.getElementById('useCurrentLocation').addEventListener('click', function() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // 1 derece Ã§apÄ±nda alan oluÅŸtur
                        const margin = 0.5;
                        updateCoordinateInputs(lat - margin, lat + margin, lon - margin, lon + margin);
                        updateMapRectangle();
                        
                        map.setView([lat, lon], 10);
                        showAlert('Mevcut konumunuz kullanÄ±ldÄ±!', 'success');
                    }, function(error) {
                        showAlert('Konum alÄ±namadÄ±: ' + error.message, 'warning');
                    });
                } else {
                    showAlert('TarayÄ±cÄ±nÄ±z konum servicesini desteklemiyor.', 'warning');
                }
            });
            
            // Koordinat input deÄŸiÅŸikliklerini dinle
            ['lat_min', 'lat_max', 'lon_min', 'lon_max'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateMapRectangle);
            });
        }

        function startDrawing() {
            isDrawing = true;
            document.getElementById('drawRectangle').innerHTML = 'â¹ï¸ Ã‡izimi Durdur';
            document.getElementById('drawRectangle').className = 'btn btn-warning btn-sm';
            
            map.getContainer().style.cursor = 'crosshair';
            
            let startLatLng = null;
            let tempRectangle = null;
            
            map.on('mousedown', function(e) {
                if (!isDrawing) return;
                
                startLatLng = e.latlng;
                if (tempRectangle) {
                    map.removeLayer(tempRectangle);
                }
            });
            
            map.on('mousemove', function(e) {
                if (!isDrawing || !startLatLng) return;
                
                if (tempRectangle) {
                    map.removeLayer(tempRectangle);
                }
                
                const bounds = L.latLngBounds(startLatLng, e.latlng);
                tempRectangle = L.rectangle(bounds, {
                    color: '#007bff',
                    weight: 2,
                    fillOpacity: 0.2
                }).addTo(map);
            });
            
            map.on('mouseup', function(e) {
                if (!isDrawing || !startLatLng) return;
                
                const bounds = L.latLngBounds(startLatLng, e.latlng);
                const south = bounds.getSouth();
                const north = bounds.getNorth();
                const west = bounds.getWest();
                const east = bounds.getEast();
                
                updateCoordinateInputs(south, north, west, east);
                updateMapRectangle();
                
                stopDrawing();
                showAlert('Alan seÃ§ildi!', 'success');
            });
        }

        function stopDrawing() {
            isDrawing = false;
            document.getElementById('drawRectangle').innerHTML = 'ğŸ“ Alan Ã‡iz';
            document.getElementById('drawRectangle').className = 'btn btn-outline-primary btn-sm';
            map.getContainer().style.cursor = '';
            map.off('mousedown mousemove mouseup');
        }

        function updateCoordinateInputs(latMin, latMax, lonMin, lonMax) {
            document.getElementById('lat_min').value = latMin.toFixed(2);
            document.getElementById('lat_max').value = latMax.toFixed(2);
            document.getElementById('lon_min').value = lonMin.toFixed(2);
            document.getElementById('lon_max').value = lonMax.toFixed(2);
        }

        function updateMapRectangle() {
            if (drawnRectangle) {
                map.removeLayer(drawnRectangle);
            }
            
            const latMin = parseFloat(document.getElementById('lat_min').value);
            const latMax = parseFloat(document.getElementById('lat_max').value);
            const lonMin = parseFloat(document.getElementById('lon_min').value);
            const lonMax = parseFloat(document.getElementById('lon_max').value);
            
            if (!isNaN(latMin) && !isNaN(latMax) && !isNaN(lonMin) && !isNaN(lonMax)) {
                const bounds = [[latMin, lonMin], [latMax, lonMax]];
                drawnRectangle = L.rectangle(bounds, {
                    color: '#28a745',
                    weight: 2,
                    fillOpacity: 0.1
                }).addTo(map);
                
                // HaritayÄ± bounds'a fit et
                map.fitBounds(bounds, { padding: [20, 20] });
                
                // Koordinat display gÃ¼ncelle
                document.getElementById('coordinateDisplay').style.display = 'block';
                document.getElementById('selectedCoords').textContent = 
                    `(${latMin}, ${lonMin}) - (${latMax}, ${lonMax})`;
            }
        }

        function clearMapSelection() {
            if (drawnRectangle) {
                map.removeLayer(drawnRectangle);
                drawnRectangle = null;
            }
            
            document.getElementById('coordinateDisplay').style.display = 'none';
            
            // Default values
            document.getElementById('lat_min').value = '39.0';
            document.getElementById('lat_max').value = '42.0';
            document.getElementById('lon_min').value = '26.0';
            document.getElementById('lon_max').value = '45.0';
            
            updateMapRectangle();
            showAlert('Harita temizlendi.', 'info');
        }

        // Tarih validasyonu iÃ§in event listener'lar
        document.getElementById('start_date').addEventListener('change', validateDates);
        document.getElementById('end_date').addEventListener('change', validateDates);

        function validateDates() {
            const startDate = new Date(document.getElementById('start_date').value);
            const endDate = new Date(document.getElementById('end_date').value);
            const startInput = document.getElementById('start_date');
            const endInput = document.getElementById('end_date');
            
            // Tarih validasyonu
            if (startDate && endDate) {
                if (startDate > endDate) {
                    endInput.setCustomValidity('BitiÅŸ tarihi, baÅŸlangÄ±Ã§ tarihinden Ã¶nce olamaz!');
                    endInput.classList.add('is-invalid');
                } else {
                    endInput.setCustomValidity('');
                    endInput.classList.remove('is-invalid');
                }
                
                // Tarih sÄ±rasÄ± kontrolÃ¼
                if (dayDiff >= 0) {
                    endInput.setCustomValidity('');
                    endInput.classList.remove('is-invalid');
                }
            }
        }

        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                lat_min: parseFloat(document.getElementById('lat_min').value),
                lat_max: parseFloat(document.getElementById('lat_max').value),
                lon_min: parseFloat(document.getElementById('lon_min').value),
                lon_max: parseFloat(document.getElementById('lon_max').value),
                start_date: document.getElementById('start_date').value,
                end_date: document.getElementById('end_date').value,
                step: parseFloat(document.getElementById('step').value)
            };

            // Koordinat validasyonu
            if (formData.lat_min >= formData.lat_max) {
                showAlert('Min enlem, max enlemden kÃ¼Ã§Ã¼k olmalÄ±!', 'danger');
                return;
            }
            if (formData.lon_min >= formData.lon_max) {
                showAlert('Min boylam, max boylamdan kÃ¼Ã§Ã¼k olmalÄ±!', 'danger');
                return;
            }
            
            // Koordinat sÄ±nÄ±rlarÄ± (-90 to 90 for lat, -180 to 180 for lon)
            if (formData.lat_min < -90 || formData.lat_max > 90) {
                showAlert('Enlem -90 ile 90 derece arasÄ±nda olmalÄ±!', 'danger');
                return;
            }
            if (formData.lon_min < -180 || formData.lon_max > 180) {
                showAlert('Boylam -180 ile 180 derece arasÄ±nda olmalÄ±!', 'danger');
                return;
            }
            
            // Tarih validasyonu
            const startDate = new Date(formData.start_date);
            const endDate = new Date(formData.end_date);
            const today = new Date();
            
            if (startDate > endDate) {
                showAlert('BaÅŸlangÄ±Ã§ tarihi, bitiÅŸ tarihinden sonra olamaz!', 'danger');
                return;
            }
            
            if (endDate > today) {
                showAlert('Gelecek tarihler iÃ§in veri mevcut deÄŸil!', 'warning');
                return;
            }
            
            // Tarih aralÄ±ÄŸÄ± pozitif olmalÄ±
            const dayDiff = (endDate - startDate) / (1000 * 60 * 60 * 24);
            if (dayDiff < 0) {
                showAlert('GeÃ§ersiz tarih aralÄ±ÄŸÄ±!', 'danger');
                return;
            }

            startAnalysis(formData);
        });

        function showAlert(message, type = 'info') {
            // Eski alert'leri temizle
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            const form = document.getElementById('analysisForm');
            form.parentNode.insertBefore(alertDiv, form.nextSibling);
            
            // 5 saniye sonra otomatik kapat
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function startAnalysis(data) {
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('resultsSection').style.display = 'none';
            
            fetch('/api/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                currentTaskId = data.task_id;
                checkProgress();
            })
            .catch(error => {
                alert('Hata: ' + error.message);
                document.getElementById('progressSection').style.display = 'none';
            });
        }

        function checkProgress() {
            if (!currentTaskId) return;

            fetch(`/api/progress/${currentTaskId}`)
            .then(response => response.json())
            .then(data => {
                updateProgress(data);
                
                if (data.status === 'tamamlandÄ±') {
                    showResults(data.result);
                } else if (data.status === 'hata') {
                    alert('Hata: ' + data.error);
                    document.getElementById('progressSection').style.display = 'none';
                } else {
                    setTimeout(checkProgress, 1000);
                }
            })
            .catch(error => {
                console.error('Progress check error:', error);
                setTimeout(checkProgress, 2000);
            });
        }

        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressStatus = document.getElementById('progressStatus');
            
            progressBar.style.width = data.percentage + '%';
            progressBar.textContent = Math.round(data.percentage) + '%';
            
            let statusClass = 'status-warning';
            if (data.status === 'tamamlandÄ±') statusClass = 'status-success';
            if (data.error) statusClass = 'status-error';
            
            progressStatus.innerHTML = `<span class="status-badge ${statusClass}">${data.status}</span>`;
        }

        function showResults(result) {
            document.getElementById('resultsSection').style.display = 'block';
            
            // Risk analizini gÃ¶ster
            if (result.risk_analysis) {
                showRiskAnalysis(result.risk_analysis);
            }
            
            // Ä°statistikleri gÃ¶ster
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';
            
            const stats = result.statistics;
            const paramNames = {
                'temperature': 'ğŸŒ¡ï¸ SÄ±caklÄ±k (Â°C)',
                'wind_speed': 'ğŸ’¨ RÃ¼zgar (m/s)',
                'precipitation': 'ğŸŒ§ï¸ YaÄŸÄ±ÅŸ (mm)',
                'humidity': 'ğŸ’§ Nem (%)'
            };
            
            Object.keys(stats).forEach(key => {
                const stat = stats[key];
                const statCard = document.createElement('div');
                statCard.className = 'stat-card';
                statCard.innerHTML = `
                    <h6>${paramNames[key] || key}</h6>
                    <div class="stat-value">${stat.average.toFixed(2)}</div>
                    <div class="stat-label">Ortalama</div>
                    <small>Min: ${stat.minimum.toFixed(2)} | Max: ${stat.maximum.toFixed(2)}</small>
                `;
                statsGrid.appendChild(statCard);
            });
            
            // Performance bilgisi gÃ¶ster
            if (result.cache_hits !== undefined) {
                const perfCard = document.createElement('div');
                perfCard.className = 'stat-card';
                perfCard.style.backgroundColor = '#f8f9fa';
                perfCard.innerHTML = `
                    <h6>âš¡ Performans</h6>
                    <div class="stat-value">${result.cache_hits}</div>
                    <div class="stat-label">Cache Hits</div>
                    <small>Toplam: ${result.total_points} nokta</small>
                `;
                statsGrid.appendChild(perfCard);
            }
            
            // Grafikleri gÃ¶ster
            const chartsContainer = document.getElementById('chartsContainer');
            chartsContainer.innerHTML = `
                <div class="row">
                    <div class="col-12">
                        <img src="/api/chart/weather_analysis.png?t=${Date.now()}" class="img-fluid" alt="Hava Durumu Analizi">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <img src="/api/chart/weather_statistics.png?t=${Date.now()}" class="img-fluid" alt="Ä°statistikler">
                    </div>
                </div>
            `;
            
            // Export butonlarÄ±nÄ± etkinleÅŸtir
            setupExportButtons();
        }

        function setupExportButtons() {
            document.getElementById('exportJson').addEventListener('click', function() {
                exportData('json');
            });
            
            document.getElementById('exportCsv').addEventListener('click', function() {
                exportData('csv');
            });
        }

        function exportData(format) {
            if (!currentTaskId) {
                showAlert('Ã–nce bir analiz yapmalÄ±sÄ±nÄ±z!', 'warning');
                return;
            }
            
            const exportButton = document.getElementById(`export${format.charAt(0).toUpperCase() + format.slice(1)}`);
            const originalText = exportButton.innerHTML;
            
            exportButton.innerHTML = 'â³ Ä°ndiriliyor...';
            exportButton.disabled = true;
            
            // Download link oluÅŸtur
            const downloadUrl = `/api/export/${currentTaskId}/${format}`;
            
            // Invisible link oluÅŸturup tÄ±kla
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.style.display = 'none';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Button'u geri yÃ¼kle
            setTimeout(() => {
                exportButton.innerHTML = originalText;
                exportButton.disabled = false;
                showAlert(`${format.toUpperCase()} dosyasÄ± indiriliyor...`, 'success');
            }, 1000);
        }

        function showRiskAnalysis(riskData) {
            const riskContainer = document.getElementById('riskAnalysis');
            
            const riskLevelColors = {
                'high': 'danger',
                'medium': 'warning', 
                'low': 'success'
            };
            
            const riskIcons = {
                'very_hot': 'ğŸŒ¡ï¸',
                'very_cold': 'ğŸ¥¶',
                'very_windy': 'ğŸ’¨',
                'very_wet': 'ğŸŒ§ï¸',
                'very_uncomfortable': 'ğŸ’§'
            };
            
            let riskHtml = '';
            
            // Overall assessment
            if (riskData.overall_assessment) {
                const assessment = riskData.overall_assessment;
                riskHtml += `
                    <div class="alert alert-${riskLevelColors[assessment.risk_level]} mb-3">
                        <h6><strong>Genel DeÄŸerlendirme: ${assessment.risk_level.toUpperCase()}</strong></h6>
                        <p class="mb-0">${assessment.recommendation}</p>
                    </div>
                `;
            }
            
            // Individual risks
            riskHtml += '<div class="row">';
            
            Object.keys(riskData).forEach(riskKey => {
                if (riskKey === 'overall_assessment') return;
                
                const risk = riskData[riskKey];
                const icon = riskIcons[riskKey] || 'âš ï¸';
                const color = riskLevelColors[risk.risk_level];
                
                riskHtml += `
                    <div class="col-md-6 mb-3">
                        <div class="card border-${color}">
                            <div class="card-body">
                                <h6 class="card-title">${icon} ${riskKey.replace('_', ' ').toUpperCase()}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="badge bg-${color}">${risk.probability.toFixed(1)}%</span>
                                    <small class="text-muted">${risk.description}</small>
                                </div>
                                <div class="progress mt-2" style="height: 8px;">
                                    <div class="progress-bar bg-${color}" style="width: ${risk.probability}%"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            riskHtml += '</div>';
            riskContainer.innerHTML = riskHtml;
        }
    </script>
</body>
</html>